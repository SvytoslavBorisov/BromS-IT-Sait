<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ú–∏–Ω–∏-–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0f1115; --card:rgba(255,255,255,.06); --line:rgba(255,255,255,.12); --txt:#fff; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--txt); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { min-height:100%; display:grid; place-items:center; padding:16px; }
    .card {
      width:min(680px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px; padding:20px;
      box-shadow:0 10px 40px rgba(0,0,0,.5);
      backdrop-filter: blur(10px);
    }
    h1 { margin:0 0 12px; font-size:22px; }
    .muted { opacity:.8; margin-bottom:12px; }
    .q { font-size:18px; margin-bottom:12px; }
    .grid { display:grid; gap:12px; }
    .btn {
      padding:14px 16px; border-radius:12px; border:1px solid var(--line);
      background: rgba(255,255,255,.08); color:var(--txt);
      text-align:left; cursor:pointer;
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .pill { padding:12px 16px; border-radius:12px; border:none; cursor:pointer; }
    .pill[disabled] { opacity:.6; cursor:default; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üß† –ë–∞–∑–æ–≤–∞—è –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞</h1>
      <div class="muted" id="progress"></div>
      <div class="q" id="question"></div>
      <div class="grid" id="answers"></div>
      <div id="final" style="display:none">
        <div style="font-size:20px; margin:8px 0">–ì–æ—Ç–æ–≤–æ! üéâ</div>
        <div class="muted">–í–∞—à —Å—á—ë—Ç: <b id="score"></b></div>
        <div class="row" style="margin-top:8px">
          <button class="pill" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
          <button class="pill" id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É</button>
          <button class="pill" id="restart" style="opacity:.9">–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    try {
      tg?.ready();
      tg?.expand();
      tg?.setHeaderColor?.('secondary_bg_color');
      tg?.setBackgroundColor?.('#0f1115');
    } catch {}

    // –í–æ–ø—Ä–æ—Å—ã
    const QUIZ = [
      { q: "–°–º–æ–ª–∞ –≤ SLA-–ø–µ—á–∞—Ç–∏ ‚Äî —ç—Ç–æ‚Ä¶", a: ["–ü–ª–∞—Å—Ç–∏–∫ –≤ –∫–∞—Ç—É—à–∫–∞—Ö", "–§–æ—Ç–æ–ø–æ–ª–∏–º–µ—Ä", "–ì–∏–ø—Å"], right: 1 },
      { q: "–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–ª–∞–π—Å–µ—Ä?", a: ["–ö–ª–µ–∏—Ç –¥–µ—Ç–∞–ª–∏", "–ü—Ä–æ–µ—Ü–∏—Ä—É–µ—Ç —Å–≤–µ—Ç", "–†–µ–∂–µ—Ç –º–æ–¥–µ–ª—å –Ω–∞ —Å–ª–æ–∏"], right: 2 },
      { q: "FDM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç‚Ä¶", a: ["–õ–∞–∑–µ—Ä", "–£–§-–ø—Ä–æ–µ–∫—Ç–æ—Ä", "–ù–∞–≥—Ä–µ—Ç—É—é —ç–∫—Å—Ç—Ä—É–∑–∏—é"], right: 2 }
    ];

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const elProgress = document.getElementById('progress');
    const elQ = document.getElementById('question');
    const elAns = document.getElementById('answers');
    const elFinal = document.getElementById('final');
    const elScore = document.getElementById('score');
    const elSave = document.getElementById('save');
    const elSend = document.getElementById('send');
    const elRestart = document.getElementById('restart');

    let idx = 0, score = 0, finished = false;
    const INIT_DATA = tg?.initData || ''; // –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ initData

    function render() {
      if (finished) {
        elProgress.style.display = 'none';
        elQ.style.display = 'none';
        elAns.style.display = 'none';
        elFinal.style.display = 'block';
        elScore.textContent = `${score} –∏–∑ ${QUIZ.length}`;
        return;
      }
      const cur = QUIZ[idx];
      elProgress.textContent = `–í–æ–ø—Ä–æ—Å ${idx + 1} / ${QUIZ.length}`;
      elQ.textContent = cur.q;
      elAns.innerHTML = '';
      cur.a.forEach((opt, i) => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = opt;
        b.onclick = () => onAnswer(i);
        elAns.appendChild(b);
      });
      elProgress.style.display = '';
      elQ.style.display = '';
      elAns.style.display = 'grid';
      elFinal.style.display = 'none';
    }

    function onAnswer(i) {
      if (finished) return;
      if (i === QUIZ[idx].right) score++;
      if (idx + 1 < QUIZ.length) { idx++; render(); }
      else { finished = true; render(); }
    }

    async function save() {
      try {
        elSave.disabled = true;
        const r = await fetch('/api/progress', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': INIT_DATA },
          body: JSON.stringify({ score })
        });
        const j = await r.json();
        if (j.ok) tg?.showPopup?.({ title: '–ì–æ—Ç–æ–≤–æ', message: `–°—á—ë—Ç ${score} —Å–æ—Ö—Ä–∞–Ω—ë–Ω`, buttons:[{ type:'ok' }] });
        else throw new Error(j.error || 'save failed');
      } catch (e) {
        tg?.showPopup?.({ title: '–û—à–∏–±–∫–∞', message: String(e?.message || e), buttons:[{ type:'ok' }] });
      } finally {
        elSave.disabled = false;
      }
    }

    function sendToBot() {
      try { tg?.sendData?.(JSON.stringify({ kind: 'quizScore', score })); }
      catch (e) {}
    }

    function restart() {
      idx = 0; score = 0; finished = false; render();
    }

    elSave.onclick = save;
    elSend.onclick = sendToBot;
    elRestart.onclick = restart;

    render();
  </script>
</body>
</html>
